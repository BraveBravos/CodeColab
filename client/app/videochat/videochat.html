<div class='video-chat-area'>
<div class='video-chats-area'>
      <div id='video-chats'>
        <div id='remote-media-streams'></div>
        <div id='local-media-stream'></div>
      </div>
  </div>

<script type='text/javascript' src='app/videochat/meeting.js'></script>
<script type="text/javascript">

var mrn = 'rtcmrn';

var meeting = new Meeting('codecolab');

var remoteMediaStreams = document.getElementById('video-chats');
var localMediaStream = document.getElementById('local-media-stream');

// on getting local or remote streams
meeting.onaddstream = function(e) {
      console.log('onaddstream e.type = ',e.type);
    if(e.type == 'remote'){
      remoteMediaStreams.insertBefore(e.video, remoteMediaStreams.firstChild);
      e.video.className = 'their-video';
    }else if(e.type === 'local'){
       localMediaStream.insertBefore(e.video, localMediaStream.firstChild);
       e.video.className = 'my-video';
    }
};



meeting.openSignalingChannel = function(onmessage) {
  console.log('meeting.openSignalingChannel onmessage',onmessage);
          var channel = location.href.replace(/\/|:|#|%|\.|\[|\]/g, '');
          //var websocket = new WebSocket('wss://wsnodejs.nodejitsu.com:443');
          
          //var websocket = new BCSocket(null, {reconnect: true});
          //websocket.port = 12034;
          var websocket = new WebSocket('ws://localhost:12034');
          websocket.onopen = function () {
            websocket.push(JSON.stringify({
              open: true,
              channel: channel
            }));
          };
          websocket.push = websocket.send;
          websocket.send = function (data) {
            if(websocket.readyState != 1) {
              return setTimeout(function() {
                websocket.send(data);
              }, 300);
            }
            
            websocket.push(JSON.stringify({
              data: data,
              channel: channel
            }));
          };
          websocket.onmessage = function(e) {
            onmessage(JSON.parse(e.data));
          };
          return websocket;
        };

meeting.onmeeting = function(){
  console.log('onmeeting meeting',meeting);
  document.getElementById('setup-new-meeting').className = 'hidden';
  document.getElementById('join-current-meeting').className = 'shown';
}

// check pre-created meeting rooms
// it is useful to auto-join
// or search pre-created sessions
// TODO set roomname to repo
meeting.check(mrn);

//meeting.firebase = 'webrtc-codecolab';

//meeting.setup(mrn);

meeting.onuserleft = function(userid) {
  //delete objStreams[userid];
  var video = document.getElementById(userid);
  if (video) video.parentNode.removeChild(video);
};

document.getElementById('setup-new-meeting').onclick = function() {
    meeting.setup(mrn);
    this.className = 'hidden';
    document.getElementById('leave-current-meeting').className = 'shown';
};

document.getElementById('join-current-meeting').onclick = function(){
  meeting.meet(mrn);
  //meeting.setup('meeting-room-name');
  this.className = 'hidden';
  document.getElementById('setup-new-meeting').className = 'hidden';
  document.getElementById('leave-current-meeting').className = 'shown';
}

document.getElementById('leave-current-meeting').onclick = function(){
  meeting.leave();
  this.className = 'hidden';
  document.getElementById('setup-new-meeting').className = 'shown';
};
</script>
<div id='controls'>
<div id='setup-new-meeting' class='shown'>Setup Video Chat</div>
<div id='join-current-meeting' class='hidden'>Join Video Chat</div>
<div id='leave-current-meeting' class='hidden'>Leave Video Chat</div>
</div>
